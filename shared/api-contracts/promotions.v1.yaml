openapi: 3.1.0
info:
  title: Promotions Service API
  version: 1.0.0
  description: >
    Manages promotions (manual and expiry_auto), attaches products with discount rates,
    and evaluates/apply discounts for carts. Publishes started/ended/updated events.

servers:
  - url: https://promotions.{env}.example.com/v1
    description: Environmented hostname
    variables:
      env: { default: staging, enum: [local, staging, prod] }
  - url: http://promotions-service:8000/v1
    description: In-cluster/internal (Docker/K8s)

tags:
  - name: Promotions
  - name: Attachments
  - name: Evaluation
  - name: Internal
  - name: Health
  - name: Events (schemas)

paths:
  /promotions:
    get:
      tags: [Promotions]
      operationId: listPromotions
      summary: List promotions (cursor pagination + filters)
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Q'
        - $ref: '#/components/parameters/Status'
        - $ref: '#/components/parameters/Kind'
        - $ref: '#/components/parameters/At'
        - $ref: '#/components/parameters/XRequestID'
      responses:
        '200':
          description: OK
          headers:
            X-Next-Cursor:
              schema: { type: string, nullable: true }
              description: Cursor for next page if present
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Promotion' }
                  count: { type: integer }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '500': { $ref: '#/components/responses/ServerError' }

    post:
      tags: [Promotions]
      operationId: createPromotion
      summary: Create a promotion (idempotent with X-Idempotency-Key)
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/XRequestID'
        - $ref: '#/components/parameters/XIdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/NewPromotion' }
      responses:
        '201':
          description: Created
          headers:
            Location:
              schema: { type: string, format: uri }
              description: URL of created resource
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Promotion' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '409': { $ref: '#/components/responses/Conflict' }
        '422': { $ref: '#/components/responses/Unprocessable' }
        '500': { $ref: '#/components/responses/ServerError' }

  /promotions/{promotionId}:
    get:
      tags: [Promotions]
      operationId: getPromotion
      summary: Get promotion by ID
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/PromotionId'
        - $ref: '#/components/parameters/XRequestID'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Promotion' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/ServerError' }

    patch:
      tags: [Promotions]
      operationId: updatePromotion
      summary: Update promotion (name, window, stackable, status)
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/PromotionId'
        - $ref: '#/components/parameters/XRequestID'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PromotionPatch' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Promotion' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '422': { $ref: '#/components/responses/Unprocessable' }
        '500': { $ref: '#/components/responses/ServerError' }

    delete:
      tags: [Promotions]
      operationId: deletePromotion
      summary: Delete/cancel a promotion
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/PromotionId'
        - $ref: '#/components/parameters/XRequestID'
      responses:
        '204': { description: No Content }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/ServerError' }

  /promotions/{promotionId}/products:
    get:
      tags: [Attachments]
      operationId: listPromotionProducts
      summary: List product attachments for a promotion
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/PromotionId'
        - $ref: '#/components/parameters/XRequestID'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/ProductPromotion' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/ServerError' }

    post:
      tags: [Attachments]
      operationId: attachProducts
      summary: Attach one or more products with discount rates
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/PromotionId'
        - $ref: '#/components/parameters/XRequestID'
        - $ref: '#/components/parameters/XIdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AttachProductsRequest' }
      responses:
        '200':
          description: Upserted
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/ProductPromotion' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
        '422': { $ref: '#/components/responses/Unprocessable' }
        '500': { $ref: '#/components/responses/ServerError' }

  /promotions/{promotionId}/products/{productId}:
    patch:
      tags: [Attachments]
      operationId: updateAttachment
      summary: Update discountRate for a product on a promotion
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/PromotionId'
        - $ref: '#/components/parameters/ProductId'
        - $ref: '#/components/parameters/XRequestID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [discountRate]
              properties:
                discountRate:
                  type: number
                  minimum: 0
                  maximum: 1
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ProductPromotion' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
        '422': { $ref: '#/components/responses/Unprocessable' }
        '500': { $ref: '#/components/responses/ServerError' }

    delete:
      tags: [Attachments]
      operationId: detachProduct
      summary: Detach a product from a promotion
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/PromotionId'
        - $ref: '#/components/parameters/ProductId'
        - $ref: '#/components/parameters/XRequestID'
      responses:
        '204': { description: No Content }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/ServerError' }

  /products/{productId}/promotions:
    get:
      tags: [Promotions]
      operationId: getActivePromotionsForProduct
      summary: Get active/scheduled promotions for a product at a given time
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/ProductId'
        - $ref: '#/components/parameters/At'
        - $ref: '#/components/parameters/XRequestID'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/ProductPromotionWithPromotion' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '500': { $ref: '#/components/responses/ServerError' }

  /promotions/apply:
    post:
      tags: [Evaluation]
      operationId: applyPromotions
      summary: Evaluate & apply promotions to a set of line items (cart)
      description: >
        Uses active promotions at the given time. By default, promotions are **not stackable**:
        the **maximum effective rate** is applied per product. If stackingPolicy=sequential,
        the effective rate is computed as 1 - Π(1 - rate_i), clamped to [0,1].
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/XRequestID'
        - $ref: '#/components/parameters/XIdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ApplyRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ApplyResult' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '422': { $ref: '#/components/responses/Unprocessable' }
        '500': { $ref: '#/components/responses/ServerError' }

  /internal/expiry/bulk-upsert:
    post:
      tags: [Internal]
      operationId: bulkUpsertExpiryPromotions
      summary: Upsert 50%-off style promotions for expiring products (called by Inventory/cron)
      description: >
        Creates or updates promotions of kind 'expiry_auto' for products whose expiry is near.
        Default discountRate is 0.5 unless specified per item.
      security: [{ ApiKeyAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/XRequestID'
        - $ref: '#/components/parameters/XIdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [items]
              properties:
                namePrefix:
                  type: string
                  default: Expiring Soon
                defaultRate:
                  type: number
                  minimum: 0
                  maximum: 1
                  default: 0.5
                startAt:
                  type: string
                  format: date-time
                  description: If omitted, uses now()
                endAt:
                  type: string
                  format: date-time
                  description: Optional end time
                items:
                  type: array
                  items:
                    type: object
                    required: [productId]
                    properties:
                      productId: { type: string, format: uuid }
                      discountRate:
                        type: number
                        minimum: 0
                        maximum: 1
                        description: Overrides defaultRate
                      expiryDate: { type: string, format: date-time, nullable: true }
      responses:
        '200':
          description: Upserted promotions and attachments
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/ProductPromotionWithPromotion' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '422': { $ref: '#/components/responses/Unprocessable' }
        '500': { $ref: '#/components/responses/ServerError' }

  /health:
    get:
      tags: [Health]
      operationId: health
      summary: Service health
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, enum: [UP] }
                  ip: { type: string }

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: api_gateway_key

  parameters:
    PromotionId:
      name: promotionId
      in: path
      required: true
      schema: { type: string, format: uuid }
    ProductId:
      name: productId
      in: path
      required: true
      schema: { type: string, format: uuid }
    Cursor:
      name: cursor
      in: query
      schema: { type: string }
    Limit:
      name: limit
      in: query
      schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
    Q:
      name: q
      in: query
      schema: { type: string }
      description: Search by name
    Status:
      name: status
      in: query
      schema: { type: string, enum: [scheduled, active, expired, cancelled] }
    Kind:
      name: kind
      in: query
      schema: { type: string, enum: [manual, expiry_auto] }
    At:
      name: at
      in: query
      schema: { type: string, format: date-time }
      description: Evaluate status as-of this time
    XRequestID:
      name: X-Request-ID
      in: header
      schema: { type: string }
      description: Correlation ID
    XIdempotencyKey:
      name: X-Idempotency-Key
      in: header
      schema: { type: string, minLength: 8, maxLength: 80 }
      description: Prevent duplicate creates/updates on retries

  schemas:
    Promotion:
      type: object
      required: [id, name, kind, startDate, status, createdAt]
      properties:
        id: { type: string, format: uuid }
        name: { type: string, minLength: 1, maxLength: 200 }
        kind: { type: string, enum: [manual, expiry_auto], default: manual }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time, nullable: true }
        status: { type: string, enum: [scheduled, active, expired, cancelled] }
        stackable: { type: boolean, default: false }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time, nullable: true }

    NewPromotion:
      type: object
      required: [name, startDate]
      properties:
        name: { type: string, minLength: 1, maxLength: 200 }
        kind: { type: string, enum: [manual, expiry_auto], default: manual }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time, nullable: true }
        stackable: { type: boolean, default: false }

    PromotionPatch:
      type: object
      additionalProperties: false
      properties:
        name: { type: string, minLength: 1, maxLength: 200 }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time, nullable: true }
        stackable: { type: boolean }
        status: { type: string, enum: [scheduled, active, expired, cancelled] }

    ProductPromotion:
      type: object
      required: [promotionId, productId, discountRate]
      properties:
        promotionId: { type: string, format: uuid }
        productId: { type: string, format: uuid }
        discountRate:
          type: number
          minimum: 0
          maximum: 1
          description: 0.5 = 50% off

    ProductPromotionWithPromotion:
      type: object
      allOf:
        - $ref: '#/components/schemas/ProductPromotion'
        - type: object
          properties:
            promotion: { $ref: '#/components/schemas/Promotion' }

    AttachProductsRequest:
      type: object
      required: [items]
      properties:
        items:
          type: array
          minItems: 1
          items:
            type: object
            required: [productId, discountRate]
            properties:
              productId: { type: string, format: uuid }
              discountRate: { type: number, minimum: 0, maximum: 1 }

    ApplyRequest:
      type: object
      required: [items]
      properties:
        at: { type: string, format: date-time, nullable: true }
        currency: { type: string, pattern: '^[A-Z]{3}$', default: SGD }
        stackingPolicy:
          type: string
          enum: [none, sequential]
          default: none
          description: >
            none = choose the single max discount per product;
            sequential = apply sequentially: 1 - Π(1 - rate_i)
        items:
          type: array
          minItems: 1
          items:
            type: object
            required: [productId, unitPrice, quantity]
            properties:
              productId: { type: string, format: uuid }
              unitPrice: { type: number, format: float, minimum: 0 }
              quantity: { type: integer, minimum: 1 }

    ApplyResult:
      type: object
      required: [currency, items, totals]
      properties:
        currency: { type: string, pattern: '^[A-Z]{3}$' }
        items:
          type: array
          items:
            type: object
            required: [productId, quantity, unitPrice, unitPriceAfter, effectiveDiscountRate, lineSubtotalBefore, lineDiscountAmount, lineSubtotalAfter]
            properties:
              productId: { type: string, format: uuid }
              quantity: { type: integer }
              unitPrice: { type: number, format: float }
              appliedPromotions:
                type: array
                items:
                  type: object
                  properties:
                    promotionId: { type: string, format: uuid }
                    name: { type: string }
                    discountRate: { type: number, minimum: 0, maximum: 1 }
              effectiveDiscountRate: { type: number, minimum: 0, maximum: 1 }
              unitPriceAfter: { type: number, format: float }
              lineSubtotalBefore: { type: number, format: float }
              lineDiscountAmount: { type: number, format: float }
              lineSubtotalAfter: { type: number, format: float }
        totals:
          type: object
          required: [before, discount, after]
          properties:
            before: { type: number, format: float }
            discount: { type: number, format: float }
            after: { type: number, format: float }

    # Outbound event payloads (for your message broker)
    PromotionStartedEvent:
      type: object
      properties:
        eventType: { const: promotion.started }
        promotionId: { type: string, format: uuid }
        occurredAt: { type: string, format: date-time }
      required: [eventType, promotionId, occurredAt]

    PromotionEndedEvent:
      type: object
      properties:
        eventType: { const: promotion.ended }
        promotionId: { type: string, format: uuid }
        occurredAt: { type: string, format: date-time }
      required: [eventType, promotionId, occurredAt]

    PromotionProductUpdatedEvent:
      type: object
      properties:
        eventType: { const: promotion.product_updated }
        promotionId: { type: string, format: uuid }
        productId: { type: string, format: uuid }
        discountRate: { type: number, minimum: 0, maximum: 1 }
        occurredAt: { type: string, format: date-time }
      required: [eventType, promotionId, productId, discountRate, occurredAt]

    Problem:
      type: object
      description: RFC 7807 problem+json
      properties:
        type:   { type: string, format: uri }
        title:  { type: string }
        status: { type: integer }
        detail: { type: string }
        instance: { type: string, format: uri }
      required: [title, status]

  responses:
    BadRequest:
      description: Validation or malformed input
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Unauthorized:
      description: Missing/invalid API key
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Conflict:
      description: State conflict (e.g., duplicate name or time overlap rules)
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Unprocessable:
      description: Semantically invalid (e.g., discountRate > 1)
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    ServerError:
      description: Unexpected error
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
